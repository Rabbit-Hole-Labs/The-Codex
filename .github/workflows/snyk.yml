name: Snyk Combined Scan with JSON Output and Analysis
on: [push, pull_request]
jobs:
  combined_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Snyk Monitor and Code Test (Capture Output)
        uses: snyk/actions/setup@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        id: snyk_scans # Give the step an ID
        run: |
          snyk test --all-projects --json > snyk_monitor_results.json || true
          snyk code test --json > snyk_code_results.json || true
      - name: Analyze Scan Results
        shell: bash
        run: |
          if [[ $(jq '.vulnerabilities | length' snyk_monitor_results.json) -gt 0 ]]; then
            echo "Snyk Monitor found vulnerabilities:"
            cat snyk_monitor_results.json
            exit 1 # Fail based on monitor results
          fi
          if [[ $(jq '.vulnerabilities | length' snyk_code_results.json) -gt 0 ]] || [[ $(jq '.suggestions | length' snyk_code_results.json) -gt 0 ]]; then
            echo "Snyk Code Test found vulnerabilities or suggestions:"
            cat snyk_code_results.json
            exit 1 # Fail based on code test results.
          fi
          echo "No vulnerabilities found."
